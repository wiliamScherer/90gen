---
title: "Cirurgias Dermatol√≥gicas em Nonagen√°rios"
subtitle: '"Nonagen√°rios" me lembra "nona", que me lembra "pic√£o da nona" üíñ'
author: "Jinfy Maria dos Santos Goedert"
date: today
date-format: "DD.MM.YYYY"
lang: pt-BR
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    toc-title: "L√°zaro"
    number-sections: true
    code-fold: true
    code-summary: "Ver c√≥digo"
    fig-width: 8
    fig-height: 5
    fig-dpi: 150
execute:
  echo: false
  warning: false
  message: false
  freeze: false
  cache: false
---

```{r}
#| label: setup
#| include: false

# ============================================================================
# DEPEND√äNCIAS
# ============================================================================
library(dplyr)
library(tidyr)
library(stringr)
library(forcats)
library(ggplot2)
library(gtsummary)
library(gt)
library(scales)
library(purrr)
library(tibble)
library(htmltools)
library(flextable)
library(broom)

# ============================================================================
# RAIZ DO PROJETO
# ============================================================================
find_project_root <- function(start = getwd(), marker = "90gen.Rproj", max_up = 15) {
  p <- normalizePath(start, winslash = "/", mustWork = FALSE)
  for (i in 0:max_up) {
    if (file.exists(file.path(p, marker))) return(p)
    up <- normalizePath(file.path(p, ".."), winslash = "/", mustWork = FALSE)
    if (identical(up, p)) break
    p <- up
  }
  normalizePath(start, winslash = "/", mustWork = FALSE)
}

proj <- Sys.getenv("QUARTO_PROJECT_DIR", unset = getwd())
renv_root <- find_project_root(proj)

if (!file.exists(file.path(renv_root, "90gen.Rproj"))) {
  stop("N√£o encontrei a raiz do projeto (90gen.Rproj) subindo a partir de: ", proj)
}

# ============================================================================
# üé® PALETA DE cor - CONTROLE CENTRALIZADO
# ============================================================================
# Quer mudar a identidade visual do documento inteiro? √â s√≥ mexer aqui!

source(file.path(renv_root, "scripts", "97_Colori.R"))

cor <- c(
    cbc = hue("azul claro"),
    cec = hue("azul escuro"),
    visita1 = hue("azul13"),
    visita2 = hue("azul18"),
    livres = hue("azul c√©u"),
    branco = hue("branco")
)

# ============================================================================
# DADOS
# ============================================================================
pacientes_path <- file.path(renv_root, "data", "derived", "pacientes.rds")
lesoes_path    <- file.path(renv_root, "data", "derived", "lesoes.rds")

stopifnot(file.exists(pacientes_path), file.exists(lesoes_path))

pacientes <- readRDS(pacientes_path)
lesoes    <- readRDS(lesoes_path)

# ============================================================================
# TEMA GLOBAL PARA GR√ÅFICOS
# ============================================================================
theme_set(
  theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(color = hue("preto", ph = 0.84)),
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
)

# ============================================================================
# FUN√á√ïES AUXILIARES
# ============================================================================
fmt_npct <- function(k, n) sprintf("%d (%.1f%%)", k, 100 * k / n)

# Tradu√ß√£o PT-BR para gtsummary
ptbr <- function(x,
                 local = c("geral", "header", "footnote", "source_note", "title", "subtitle"),
                 dict_extra = NULL,
                 warn_untranslated = FALSE) {
  local <- match.arg(local)
  if (!is.character(x)) x <- as.character(x)

  dict <- list(
    geral = c(
      "p-value" = "p-valor", "95% CI" = "IC 95%",
      "Characteristic" = "Caracter√≠stica", "Overall" = "Total",
      "Abbreviations" = "Abrevia√ß√µes", "Fisher's exact test" = "Teste exato de Fisher",
      "CI = Confidence Interval, OR = Odds Ratio" = "IC = Intervalo de confian√ßa, OR = Raz√£o de chances"
    ),
    header = c("p-value" = "p-valor", "95% CI" = "IC 95%", "Characteristic" = "Caracter√≠stica", "Overall" = "Total"),
    footnote = c("Fisher's exact test" = "Teste exato de Fisher"),
    source_note = c("Abbreviations" = "Abrevia√ß√µes"),
    title = c(), subtitle = c()
  )

  map <- c(dict$geral, dict[[local]])
  if (!is.null(dict_extra)) map <- c(map, dict_extra)

  translate_one <- function(s) {
    if (s %in% names(map)) return(unname(map[s]))
    keys <- names(map)[order(nchar(names(map)), decreasing = TRUE)]
    out <- s
    for (k in keys) out <- gsub(k, map[[k]], out, fixed = TRUE)
    out
  }

  vapply(x, translate_one, FUN.VALUE = character(1))
}

# ============================================================================
# DADOS ANAL√çTICOS PR√â-PROCESSADOS
# ============================================================================
lesoes_analise <- lesoes |>
  mutate(
    teve_complicacao = !is.na(complicacao) & str_squish(as.character(complicacao)) != "",
    teve_reintervencao = as.logical(reintervencao) %in% TRUE,
    margem_comprometida = case_when(
      is.na(margens_ap) ~ NA,
      str_detect(margens_ap, "comprometid") ~ TRUE,
      margens_ap == "livres" ~ FALSE,
      TRUE ~ NA
    ),
    fech_label = case_when(
      fech == "direto" ~ "Fechamento direto",
      fech == "retalho" ~ "Retalho",
      fech == "enxerto" ~ "Enxerto",
      fech == "2intencao" ~ "Segunda inten√ß√£o",
      TRUE ~ as.character(fech)
    ),
    local_grupo = case_when(
      localizacao == "face" ~ "Face",
      localizacao == "orelha" ~ "Orelha",
      localizacao == "couro cabeludo" ~ "Couro cabeludo",
      localizacao %in% c("t√≥rax", "dorso") ~ "Tronco",
      localizacao == "cervical" ~ "Cervical",
      str_detect(localizacao, "membro superior|antebra√ßo") ~ "Membro superior",
      str_detect(localizacao, "membro inferior|p√©") ~ "Membro inferior",
      TRUE ~ "Outro"
    ),
    subtipo_agressivo = case_when(
      histo_tipo != "cbc" ~ NA,
      str_detect(histo_subtipo, "infiltrativo|escleroderm|micronodular") ~ TRUE,
      TRUE ~ FALSE
    ),
    tipo_label = toupper(histo_tipo)
  )

comorb_cols <- c("has", "dm", "dlp", "ic", "fa", "drc", "alzheimer", "parkinson", "dpoc")
comorb_cols <- intersect(comorb_cols, names(pacientes))

pacientes_compl <- pacientes |>
  mutate(
    n_comorb = rowSums(across(all_of(comorb_cols), ~ as.integer(.x %in% TRUE)), na.rm = TRUE),
    faixa_comorb = cut(n_comorb, breaks = c(-1, 0, 2, Inf), labels = c("0", "1-2", "3+"))
  )

lesoes_full <- lesoes_analise |>
  left_join(
    pacientes_compl |> select(paciente, idade, sexo, fototipo, n_comorb, faixa_comorb),
    by = "paciente"
  )

# C√°lculos globais usados em v√°rias se√ß√µes
pct_cbc <- mean(lesoes$histo_tipo == "cbc", na.rm = TRUE) * 100
pct_cec <- mean(lesoes$histo_tipo == "cec", na.rm = TRUE) * 100
n_compl <- sum(lesoes_analise$teve_complicacao, na.rm = TRUE)
n_marg <- sum(lesoes_analise$margem_comprometida, na.rm = TRUE)
n_reint <- sum(lesoes_analise$teve_reintervencao, na.rm = TRUE)
```

# Disclaimer

Hello didi, esse documento √© a vers√£o **unificada e turbinada** da an√°lise dos teus dados. Organizei tudo de um jeito que d√° pra ver o que est√° acontecendo, entender os padr√µes, e ‚Äî o mais importante ‚Äî **testar se as diferen√ßas que a gente enxerga s√£o reais ou s√≥ obra do acaso**.

**O que temos em m√µes:**

-   **`r nrow(pacientes)` pacientes** no total
-   **`r nrow(lesoes)` les√µes** operadas no total


**Roteiro da nossa jornada espiritual:**

1.  **Descritiva** ‚Äî Quem s√£o os pacientes? Como s√£o as les√µes?
2.  **Bivariada** ‚Äî Aqui a gente cruza vari√°veis buscando associa√ß√µes
3.  **Multivariada** ‚Äî Aqui vou ser vaidoso: √© uma estat√≠stica anal√≠tica um pouco mais sofisticada
4.  **Recorr√™ncia** ‚Äî Investiga√ß√£o dos pacientes que tiveram duas visitas (qual o problema deles?)
5.  **Heatmaps** ‚Äî Meio que um radar pra explorar correla√ß√µes



------------------------------------------------------------------------

# Parte I: Descritiva {#sec-descritiva}

## Quem s√£o esses velhos?

### "Mas quem tu √©?"

```{r}
#| label: tbl-demografica
#| tbl-cap: "Caracter√≠sticas dos pacientes"

df_tab <- pacientes |>
  mutate(
    sexo_label = factor(sexo, c("f", "m"), c("Feminino", "Masculino")),
    fototipo = factor(fototipo)
  )

tbl_idade_gts <- df_tab |>
  select(idade) |>
  tbl_summary(
    label = list(idade ~ "Idade (anos)"),
    statistic = list(all_continuous() ~ "{median} ({p25}‚Äì{p75})"),
    digits = list(all_continuous() ~ 1),
    missing = "no"
  )

tbl_outros_gts <- df_tab |>
  select(sexo_label, fototipo, cbc_cec_previo, mohs, mais_cx, obito) |>
  tbl_summary(
    label = list(
      sexo_label ~ "Sexo",
      fototipo ~ "Fototipo (Fitzpatrick)",
      cbc_cec_previo ~ "J√° teve CBC/CEC antes",
      mohs ~ "Fez Mohs",
      mais_cx ~ "Teve outras cirurgias",
      obito ~ "Faleceu no seguimento"
    ),
    statistic = list(all_categorical() ~ "{n} ({p}%)"),
    digits = list(all_categorical() ~ c(0, 1)),
    missing = "no"
  )

tbl_idade_gt <- tbl_idade_gts |> bold_labels() |> as_gt()
tbl_outros_gt <- tbl_outros_gts |> bold_labels() |> as_gt()

if (knitr::is_html_output()) {
  htmltools::div(
    style = "display:flex; gap:18px; align-items:flex-start;",
    htmltools::div(style = "flex: 0 0 32%;", htmltools::HTML(gt::as_raw_html(tbl_idade_gt))),
    htmltools::div(style = "flex: 1 1 68%;", htmltools::HTML(gt::as_raw_html(tbl_outros_gt)))
  )
} else {
  tbl_idade_gts |> bold_labels() |> as_flex_table()
  tbl_outros_gts |> bold_labels() |> as_flex_table()
}
```

```{r}
#| label: fig-idade
#| fig-cap: "Distribui√ß√£o de idade"

pacientes |>
  ggplot(aes(x = idade)) +
  geom_histogram(binwidth = 1, fill = hue("azul"), color = hue("branco"), alpha = 0.8) +
  geom_vline(xintercept = median(pacientes$idade), linetype = "dashed", color = "gray30", linewidth = 0.8) +
  annotate("text", x = median(pacientes$idade) + 0.5, y = Inf, vjust = 2, hjust = 0,
           label = paste0("Mediana: ", median(pacientes$idade), " anos"), size = 3.5, color = hue("cinza")) +
  scale_x_continuous(breaks = seq(90, 110, 2)) +
  labs(x = "Idade (anos)", y = "N√∫mero de pacientes",
       title = "A idade dos teus pacientes", subtitle = "Todo mundo tem 90+, mas olha a varia√ß√£o!")

q <- quantile(pacientes$idade, probs = c(0.25, 0.75), na.rm = TRUE)
p25 <- unname(q[1])
p50 <- median(pacientes$idade, na.rm = TRUE)
p75 <- unname(q[2])
iqr <- IQR(pacientes$idade, na.rm = TRUE)

```

Olha que interessante: a [mediana](#nota-definicoes) √© `r median(pacientes$idade)` anos. Isso significa que metade dos teus pacientes tem **mais** que isso. √â uma popula√ß√£o bem idosa mesmo ‚Äî o que faz total sentido pro teu recorte.

::: callout-note
## Por que vamos usar mediana e n√£o m√©dia?

Sim, eu tamb√©m gosto da **m√©dia**. Ela √© um √≥timo resumo estat√≠stico quando os dados s√£o sim√©tricos (ou seja, quando os valores giram em torno de um ponto central).

S√≥ que como d√° pra ver no @fig-idade, a nossa amostra √© assim√©trica (d√° pra ver direitinho que a maior massa de pacientes t√° √† esquerda), e isso distorce a m√©dia. Por esse motivo, ela n√£o √© a primeira linha no nosso caso.

A **mediana**, n√£o sei se tu lembra, √© exatamente o valor que divide a amostra em duas metades iguais. Metade dos pacientes tem idade menor que a mediana, e metade maior. Ela acaba sendo bem mais robusta quando a gente lida com valores extremos (tipo um paciente com 110 anos) e d√° uma ideia melhor do "centro" quando os dados n√£o se comportam de um jeito "bonitinho" em torno do centro.

Vale lembrar que essas estat√≠sticas sempre tem seu parzinho. Pra m√©dia, existe o desvio padr√£o. O **intervalo interquartil** *(Ou IIQ, para os √≠ntimos)*: √© uma medida de dispers√£o (assim como o desvio padr√£o). Ele cont√©m os 50% centrais das observa√ß√µes (aqui, no caso, idade). Como ele filtra as pontas (os 25% maiores/menores), acaba sendo mais resistente a *outliers* (vamos supor, um paciente de 119 anos poderia distorcer a m√©dia e o desvio-padr√£o... O combo mediana/IIQ seguiria firme).

:::

Os artigos costumam apresentar a mediana+IIQ no formato (mediana, IIQ). Sabe qual √© o nosso?
Rufem os tambores...

::: {.text-center}
‚ú®**`r paste0("(", sprintf("%.0f", p50), ", ", sprintf("%.0f", p25), "‚Äì", sprintf("%.0f", p75), ")")`**‚ú®
:::

Juro pra ti que essa estat√≠stica fica muito mais elegante em faixas menos restritas.

### E as comorbidades?

Quase ningu√©m chega nos 90 "zerado", n√©?

```{r}
#| label: fig-comorbidades
#| fig-cap: "As comorbidades mais comuns"

comorb_labels <- c(
  has = "Hipertens√£o", dm = "Diabetes", dlp = "Dislipidemia",
  ic = "Insuf. card√≠aca", fa = "Fibrila√ß√£o atrial", drc = "Doen√ßa renal cr√¥nica",
  alzheimer = "Alzheimer", parkinson = "Parkinson", dpoc = "DPOC"
)

comorb_prev <- pacientes |>
  summarise(across(all_of(comorb_cols), ~ sum(.x, na.rm = TRUE))) |>
  pivot_longer(everything(), names_to = "comorbidade", values_to = "n") |>
  mutate(pct = n / nrow(pacientes) * 100, label = comorb_labels[comorbidade], label = fct_reorder(label, pct))

comorb_prev |>
  ggplot(aes(x = label, y = pct)) +
  geom_col(fill = cor["cbc"], width = 0.7) +
  geom_text(aes(label = sprintf("%.0f%%", pct)), hjust = -0.2, size = 3.5) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 100), labels = \(x) paste0(x, "%")) +
  labs(x = NULL, y = "Preval√™ncia", title = "O que eles t√™m al√©m do c√¢ncer de pele",
       subtitle = "Spoiler: hipertens√£o lidera disparado")
```

**Hipertens√£o** em `r round(comorb_prev$pct[comorb_prev$comorbidade == "has"])`% da galera. Nenhuma surpresa.

------------------------------------------------------------------------

## As les√µes

### CBC ou CEC?

```{r}
#| label: fig-tipo-histo
#| fig-cap: "Distribui√ß√£o por tipo histol√≥gico"

lesoes |>
  filter(!is.na(histo_tipo)) |>
  count(histo_tipo) |>
  mutate(pct = n / sum(n), label_pct = scales::percent(pct, accuracy = 0.1),
         label = toupper(histo_tipo), label = fct_reorder(label, n, .desc = TRUE)) |>
  ggplot(aes(x = label, y = n, fill = histo_tipo)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = label_pct), position = position_stack(vjust = 0.5), color = hue("branco"), fontface = "bold", size = 4) +
  geom_text(aes(label = n), vjust = -0.4, color = "gray20", fontface = "bold", size = 4) +
  scale_fill_manual(values = cor[c("cbc", "cec")], guide = "none") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12))) +
  labs(x = NULL, y = "N√∫mero de les√µes", title = "CBC domina, chocando um total de zero pessoas",
       subtitle = paste0("Total: ", nrow(lesoes), " les√µes"))
```

CBC representa `r sprintf("%.0f", pct_cbc)`% das les√µes. Mas os `r sprintf("%.0f", pct_cec)`% de CEC s√£o mais preocupantes em termos de agressividade.

### Desfechos: o resumo r√°pido

```{r}
#| label: tbl-desfechos-resumo

tibble(
  Desfecho = c("Complica√ß√£o", "Margem comprometida", "Reinterven√ß√£o"),
  n = c(n_compl, n_marg, n_reint),
  `%` = sprintf("%.1f%%", 100 * c(n_compl, n_marg, n_reint) / nrow(lesoes))
) |>
  gt() |>
  tab_header(title = "Resumo dos desfechos", subtitle = paste0("N = ", nrow(lesoes), " les√µes"))
```

Poucos eventos, mas o suficiente pra gente investigar!

------------------------------------------------------------------------

# Parte II: An√°lise Bivariada {#sec-bivariada}

Agora a gente sai da contagem e entra na **associa√ß√£o**. A pergunta √©: *"quem complica mais?"*

::: callout-note
## Por que usamos o Teste Exato de Fisher?

Com poucos eventos (13 complica√ß√µes, 7 margens comprometidas), o teste de Fisher √© mais confi√°vel. Ele calcula a probabilidade exata, sem depender de aproxima√ß√µes que funcionam mal com N pequeno.
:::

## Fatores associados a COMPLICA√á√ÉO

```{r}
#| label: tbl-bivariada-complicacao
#| tbl-cap: "An√°lise bivariada: fatores associados a complica√ß√£o"

lesoes_biv <- lesoes_full |>
  filter(!is.na(teve_complicacao)) |>
  mutate(
    teve_complicacao_label = if_else(teve_complicacao, "Sim", "N√£o") |> factor(levels = c("N√£o", "Sim")),
    sexo_label = factor(sexo, c("f", "m"), c("Feminino", "Masculino")),
    tipo_label = factor(tipo_label, c("CBC", "CEC")),
    fech_simples = case_when(
      fech_label %in% c("Fechamento direto", "Segunda inten√ß√£o") ~ "Direto/2¬™ inten√ß√£o",
      TRUE ~ "Retalho/Enxerto"
    ) |> factor(levels = c("Direto/2¬™ inten√ß√£o", "Retalho/Enxerto")),
    idade_cat = cut(idade, breaks = c(89, 92, 95, Inf), labels = c("90-92", "93-95", "96+"))
  )

tbl_biv_compl <- lesoes_biv |>
  select(teve_complicacao_label, sexo_label, idade_cat, faixa_comorb, tipo_label, fech_simples, local_grupo) |>
  tbl_summary(
    by = teve_complicacao_label,
    label = list(
      sexo_label ~ "Sexo", idade_cat ~ "Faixa et√°ria", faixa_comorb ~ "N¬∫ comorbidades",
      tipo_label ~ "Tipo histol√≥gico", fech_simples ~ "T√©cnica de fechamento", local_grupo ~ "Localiza√ß√£o"
    ),
    statistic = all_categorical() ~ "{n} ({p}%)",
    digits = all_categorical() ~ c(0, 1),
    missing = "no"
  ) |>
  add_p(test = all_categorical() ~ "fisher.test") |>
  add_overall() |>
  modify_header(label ~ "**Caracter√≠stica**", stat_0 ~ "**Total**", stat_1 ~ "**N√£o**", stat_2 ~ "**Sim**", p.value ~ "**p-valor**") |>
  modify_footnote(p.value ~ "Teste exato de Fisher") |>
  bold_p(t = 0.05) |>
  bold_labels()

tbl_biv_compl |>
  as_gt() |>
  tab_header(title = "Quem complica mais?", subtitle = "An√°lise bivariada com teste exato de Fisher")
```

```{r}
#| label: calc-or-fech

tab_fech <- table(lesoes_biv$fech_simples, lesoes_biv$teve_complicacao)
or_fech <- fisher.test(tab_fech)
```

::: callout-important
## Repara:

**T√©cnica de fechamento** parece fazer diferen√ßa!

-   OR bruto: **`r sprintf("%.1f", or_fech$estimate)`** (IC95%: `r sprintf("%.1f‚Äì%.1f", or_fech$conf.int[1], or_fech$conf.int[2])`)
-   p = **`r sprintf("%.3f", or_fech$p.value)`**

Mas calma ‚Äî isso pode ser confus√£o. Les√µes que precisam de retalho/enxerto provavelmente s√£o maiores...
:::

## Fatores associados a MARGEM COMPROMETIDA

```{r}
#| label: tbl-bivariada-margem
#| tbl-cap: "An√°lise bivariada: fatores associados a margem comprometida"

lesoes_biv_marg <- lesoes_full |>
  filter(!is.na(margem_comprometida)) |>
  mutate(
    margem_label = if_else(margem_comprometida, "Sim", "N√£o") |> factor(levels = c("N√£o", "Sim")),
    tipo_label = factor(tipo_label, c("CBC", "CEC")),
    fech_simples = case_when(
      fech_label %in% c("Fechamento direto", "Segunda inten√ß√£o") ~ "Direto/2¬™ inten√ß√£o",
      TRUE ~ "Retalho/Enxerto"
    ) |> factor(levels = c("Direto/2¬™ inten√ß√£o", "Retalho/Enxerto"))
  )

tbl_biv_marg <- lesoes_biv_marg |>
  select(margem_label, tipo_label, fech_simples, local_grupo) |>
  tbl_summary(
    by = margem_label,
    label = list(tipo_label ~ "Tipo histol√≥gico", fech_simples ~ "T√©cnica de fechamento", local_grupo ~ "Localiza√ß√£o"),
    statistic = all_categorical() ~ "{n} ({p}%)",
    digits = all_categorical() ~ c(0, 1),
    missing = "no"
  ) |>
  add_p(test = all_categorical() ~ "fisher.test") |>
  add_overall() |>
  modify_header(label ~ "**Caracter√≠stica**", stat_0 ~ "**Total**", stat_1 ~ "**N√£o**", stat_2 ~ "**Sim**", p.value ~ "**p-valor**") |>
  modify_footnote(p.value ~ "Teste exato de Fisher") |>
  bold_p(t = 0.05) |>
  bold_labels()

tbl_biv_marg |>
  as_gt() |>
  tab_header(title = "Quem tem mais margem comprometida?", subtitle = "An√°lise bivariada com teste exato de Fisher")
```

------------------------------------------------------------------------

# Parte III: An√°lise Multivariada {#sec-multivariada}

A gente ajusta uma vari√°vel pela outra pra ver se o efeito **persiste**.

::: callout-warning
## Limita√ß√£o importante

Com apenas `r n_compl` complica√ß√µes, n√£o d√° pra colocar muitas vari√°veis no modelo. A regra de bolso √© \~10 eventos por vari√°vel. Ent√£o vou ser conservador: **modelo com 1-2 vari√°veis**.
:::

```{r}
#| label: modelo-complicacao

lesoes_modelo <- lesoes_biv |>
  filter(!is.na(fech_simples), !is.na(tipo_label))

if (n_compl >= 8) {
  mod_compl <- glm(
    teve_complicacao ~ fech_simples + tipo_label,
    data = lesoes_modelo,
    family = binomial(link = "logit")
  )

  tbl_mod <- mod_compl |>
    tbl_regression(
      exponentiate = TRUE,
      label = list(fech_simples ~ "T√©cnica de fechamento", tipo_label ~ "Tipo histol√≥gico")
    ) |>
    modify_column_merge(pattern = "{conf.low}, {conf.high}", rows = !is.na(.data$estimate)) |>
    modify_column_hide(columns = "conf.high") |>
    modify_header(label ~ "**Caracter√≠stica**", p.value ~ "**p-valor**", conf.low ~ "**IC 95%**") |>
    modify_footnote(conf.low ~ "IC 95% (inferior, superior)") |>
    modify_source_note("Abrevia√ß√µes: IC = Intervalo de confian√ßa; OR = Raz√£o de chances") |>
    bold_p(t = 0.05) |>
    bold_labels()

  tbl_mod |>
    as_gt() |>
    tab_header(title = "Modelo multivariado: complica√ß√£o", subtitle = "Regress√£o log√≠stica ‚Äî OR ajustado (IC 95%)")
} else {
  cat("N de eventos muito pequeno para modelo multivariado confi√°vel.")
}
```

::: callout-tip
## Interpreta√ß√£o

Se o OR ajustado continua elevado e significativo, a t√©cnica de fechamento √© um preditor **independente** de complica√ß√£o ‚Äî n√£o √© s√≥ porque as les√µes eram mais complexas.
:::

------------------------------------------------------------------------

# Parte IV: Quem voltou? {#sec-recorrencia}

Dos `r nrow(pacientes)` pacientes, **`r sum(lesoes |> group_by(paciente) |> summarise(v = n_distinct(visita)) |> pull(v) == 2)`** tiveram uma segunda cirurgia. Perguntas:

-   Quem s√£o esses pacientes que voltam?
-   A segunda cirurgia complica mais?

```{r}
#| label: tbl-visitas
#| tbl-cap: "Compara√ß√£o entre visita 1 e visita 2"

lesoes_visita <- lesoes_full |>
  mutate(visita_label = factor(visita, c(1, 2), c("Primeira cirurgia", "Segunda cirurgia")))

tbl_visita <- lesoes_visita |>
  select(visita_label, teve_complicacao, margem_comprometida, tipo_label) |>
  tbl_summary(
    by = visita_label,
    label = list(teve_complicacao ~ "Complica√ß√£o", margem_comprometida ~ "Margem comprometida", tipo_label ~ "Tipo histol√≥gico"),
    statistic = all_categorical() ~ "{n} ({p}%)",
    missing = "no"
  ) |>
  add_p(test = all_categorical() ~ "fisher.test") |>
  modify_header(label ~ "**Caracter√≠stica**", p.value ~ "**p-valor**") |>
  modify_footnote(p.value ~ "Teste exato de Fisher") |>
  bold_p(t = 0.05) |>
  bold_labels()

tbl_visita |>
  as_gt() |>
  tab_header(title = "Primeira vs Segunda cirurgia", subtitle = "Os que voltam s√£o diferentes?")
```

```{r}
#| label: fig-visita-complic
#| fig-cap: "Taxa de complica√ß√£o por visita"

lesoes_visita |>
  group_by(visita_label) |>
  summarise(n = n(), compl = sum(teve_complicacao, na.rm = TRUE), taxa = 100 * compl / n, .groups = "drop") |>
  ggplot(aes(x = visita_label, y = taxa, fill = visita_label)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = sprintf("%.1f%%\n(n=%d)", taxa, compl)), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c(cor["visita1"], cor["visita2"]), guide = "none") +
  scale_y_continuous(limits = c(0, 30), labels = \(x) paste0(x, "%")) +
  labs(x = NULL, y = "Taxa de complica√ß√£o", title = "A segunda cirurgia complica mais?",
       subtitle = "Compara√ß√£o entre primeira e segunda visita")
```

Essa an√°lise √© explorat√≥ria ‚Äî o N √© pequeno e os pacientes que voltam podem ser diferentes desde o in√≠cio.

------------------------------------------------------------------------

# Parte V: Heatmaps üî• {#sec-heatmaps}

Heatmaps s√£o √≥timos pra visualizar padr√µes que tabelas escondem.

## T√©cnica de fechamento √ó Desfechos

```{r}
#| label: fig-heatmap-fech-desfechos
#| fig-cap: "Heatmap de desfechos por t√©cnica de fechamento"
#| fig-width: 10
#| fig-height: 5

fech_levels <- c("Fechamento direto", "Enxerto", "Retalho", "Segunda inten√ß√£o")

fd <- lesoes_analise |>
  mutate(fech_label = factor(fech_label, levels = fech_levels)) |>
  filter(!is.na(fech_label)) |>
  select(fech_label, teve_complicacao, margem_comprometida, teve_reintervencao)

long <- fd |>
  pivot_longer(cols = c(teve_complicacao, margem_comprometida, teve_reintervencao),
               names_to = "desfecho", values_to = "valor") |>
  mutate(desfecho = factor(desfecho,
    levels = c("teve_complicacao", "margem_comprometida", "teve_reintervencao"),
    labels = c("Complica√ß√£o", "Margem comprometida", "Reinterven√ß√£o")))

heat_fd <- long |>
  group_by(fech_label, desfecho) |>
  summarise(
    n_sim = sum(valor %in% TRUE, na.rm = TRUE),
    n_denom = sum(!is.na(valor)),
    pct = if_else(n_denom > 0, 100 * n_sim / n_denom, NA_real_),
    label = if_else(n_denom > 0, sprintf("%d\n(%.0f%%)", n_sim, pct), ""),
    .groups = "drop"
  )

heat_fd |>
  ggplot(aes(x = desfecho, y = fech_label, fill = pct)) +
  geom_tile(color = "white", linewidth = 0.6) +
  geom_text(aes(label = label), size = 3.4) +
  scale_x_discrete(position = "top") +
  scale_fill_gradient(low = cor_heatmap_low, high = cor_heatmap_high, limits = c(0, 60),
                      breaks = c(0, 20, 40, 60), labels = \(x) paste0(x, "%"), na.value = "white") +
  labs(x = NULL, y = NULL, fill = "% de les√µes com evento",
       title = "Desfechos por t√©cnica de fechamento",
       subtitle = "Quanto mais vermelho, mais eventos") +
  theme(axis.text.x = element_text(face = "bold"), axis.text.y = element_text(size = 10))
```

Olha como **retalho e enxerto** ficam mais "quentes" na coluna de complica√ß√£o!

## CBC: Margens por subtipo (barras divergentes)

```{r}
#| label: fig-divergente-cbc-margens
#| fig-cap: "Margens por subtipo de CBC (barras divergentes)"
#| fig-width: 9
#| fig-height: 5

cbc_margens <- lesoes |>
  filter(tolower(histo_tipo) == "cbc") |>
  mutate(
    margem_status = case_when(
      is.na(margens_ap) ~ NA_character_,
      str_detect(margens_ap, "comprometida") ~ "Comprometidas",
      margens_ap == "livres" ~ "Livres",
      TRUE ~ NA_character_
    ),
    histo_subtipo = str_squish(as.character(histo_subtipo))
  ) |>
  filter(!is.na(margem_status), !is.na(histo_subtipo), histo_subtipo != "",
         histo_subtipo != "NA", !str_detect(histo_subtipo, "^[Nn][Aa]$")) |>
  separate_rows(histo_subtipo, sep = ",\\s*") |>
  mutate(histo_subtipo = str_to_sentence(str_squish(histo_subtipo)))

contagens <- cbc_margens |>
  count(histo_subtipo, margem_status) |>
  group_by(histo_subtipo) |>
  mutate(n_total = sum(n), pct = 100 * n / n_total) |>
  ungroup() |>
  mutate(
    pct_plot = if_else(margem_status == "Livres", -pct, pct),
    label = sprintf("%d (%.0f%%)", n, pct)
  )

ordem <- contagens |>
  filter(margem_status == "Comprometidas") |>
  arrange(desc(pct)) |>
  pull(histo_subtipo)

subtipos_sem_compr <- setdiff(unique(contagens$histo_subtipo), ordem)
ordem <- c(ordem, subtipos_sem_compr)

contagens <- contagens |>
  mutate(histo_subtipo = factor(histo_subtipo, levels = rev(ordem)))

ggplot(contagens, aes(x = pct_plot, y = histo_subtipo, fill = margem_status)) +
  geom_col(width = 0.7) +
  geom_text(aes(label = label), hjust = if_else(contagens$margem_status == "Livres", 1.1, -0.1),
            size = 3, color = "gray20") +
  geom_vline(xintercept = 0, color = "gray40", linewidth = 0.8) +
  scale_x_continuous(labels = \(x) paste0(abs(x), "%"), limits = c(-110, 60)) +
  scale_fill_manual(values = c("Livres" = cor["livres"], "Comprometidas" = cor["comprometidas"]), name = NULL) +
  labs(x = "Propor√ß√£o (%)", y = NULL, title = "CBC: margens livres vs comprometidas por subtipo",
       subtitle = "‚Üê Livres | Comprometidas ‚Üí") +
  theme(panel.grid.major.y = element_blank(), legend.position = "bottom")
```

------------------------------------------------------------------------

# S√≠ntese {#sec-sintese}

```{r}
#| label: resumo-final

resumo <- tibble(
  Indicador = c("Pacientes", "Les√µes", "Idade mediana", "Mulheres", "CBC",
                "Taxa de complica√ß√£o", "Margens comprometidas", "Pacientes com 2¬™ cirurgia"),
  Valor = c(
    as.character(nrow(pacientes)), as.character(nrow(lesoes)),
    paste0(median(pacientes$idade), " anos"),
    sprintf("%.0f%%", 100 * mean(pacientes$sexo == "f")),
    sprintf("%.0f%%", pct_cbc),
    sprintf("%.1f%%", 100 * n_compl / nrow(lesoes)),
    sprintf("%.1f%%", 100 * n_marg / nrow(lesoes)),
    as.character(sum(lesoes |> group_by(paciente) |> summarise(v = n_distinct(visita)) |> pull(v) == 2))
  )
)

resumo |> gt() |> tab_header(title = "Resum√£o", subtitle = "Os n√∫meros principais")
```

## O que parece importar?

1.  **T√©cnica de fechamento:** Retalho e enxerto se associam a mais complica√ß√µes.
2.  **Subtipos agressivos de CBC:** Parecem ter mais margem comprometida, mas N pequeno.
3.  **Segunda cirurgia:** Pacientes que voltam merecem aten√ß√£o.

## Limita√ß√µes (pra colocar na discuss√£o)

-   **N pequeno:** Poder estat√≠stico limitado.
-   **Dados correlacionados:** Pacientes com m√∫ltiplas les√µes violam independ√™ncia.
-   **Vi√©s de sele√ß√£o:** Quem foi operado? Quem foi pra AP?
-   **Retrospectivo:** Qualidade depende do registro original.

------------------------------------------------------------------------

# O Que Falta Fazer

-   [ ] Revisar os n√∫meros com o orientador
-   [ ] Decidir quais an√°lises entram no artigo final
-   [ ] Escrever a se√ß√£o de m√©todos
-   [ ] Pensar no t√≠tulo do trabalho üòé

------------------------------------------------------------------------

**Uma coisa importante:** tudo que est√° aqui √© pra gente entender os dados. A narrativa final do artigo pode (e deve) ser mais s√≥bria.

Me conta o que tu achou! üéØ

------------------------------------------------------------------------

*Gerado em `r format(Sys.time(), "%d/%m/%Y √†s %H:%M")`*
