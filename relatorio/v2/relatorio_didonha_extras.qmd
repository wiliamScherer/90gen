---
title: "Cirurgias Dermatol√≥gicas em Nonagen√°rios"
subtitle: '"Nonagen√°rios" me lembra "nona", que me lembra "pic√£o da nona" üíñ'
author: "Jinfy Maria dos Santos Goedert"
date: today
date-format: "DD.MM.YYYY"
lang: pt-BR
format:
  html:
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    toc-title: "Navega√ß√£o"
    number-sections: true
    code-fold: true
    code-summary: "Ver c√≥digo"
    fig-width: 8
    fig-height: 5
    fig-dpi: 150
execute:
  echo: false
  warning: false
  message: false
  freeze: false
  cache: false
---

```{r}
#| label: setup
#| include: false

# Depend√™ncias
library(dplyr)
library(tidyr)
library(stringr)
library(forcats)
library(ggplot2)
library(gtsummary)
library(gt)
library(scales)
library(purrr)
library(tibble)
library(htmltools)
library(flextable)
library(broom)

# ---- Raiz do projeto (renv_root) ----
find_project_root <- function(start = getwd(), marker = "90gen.Rproj", max_up = 15) {
  p <- normalizePath(start, winslash = "/", mustWork = FALSE)
  for (i in 0:max_up) {
    if (file.exists(file.path(p, marker))) return(p)
    up <- normalizePath(file.path(p, ".."), winslash = "/", mustWork = FALSE)
    if (identical(up, p)) break
    p <- up
  }
  normalizePath(start, winslash = "/", mustWork = FALSE)
}

proj <- Sys.getenv("QUARTO_PROJECT_DIR", unset = getwd())
renv_root <- find_project_root(proj)

if (!file.exists(file.path(renv_root, "90gen.Rproj"))) {
  stop("N√£o encontrei a raiz do projeto (90gen.Rproj) subindo a partir de: ", proj)
}

# Dados
pacientes_path <- file.path(renv_root, "data", "derived", "pacientes.rds")
lesoes_path    <- file.path(renv_root, "data", "derived", "lesoes.rds")

stopifnot(file.exists(pacientes_path), file.exists(lesoes_path))

pacientes <- readRDS(pacientes_path)
lesoes    <- readRDS(lesoes_path)

# Tema global para gr√°ficos
theme_set(
  theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(color = "gray20"),
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
)

# Fun√ß√£o para formatar n (percentual)
fmt_npct <- function(k, n) sprintf("%d (%.1f%%)", k, 100 * k / n)

azulClaro = "#4285F4"
azulEscuro = "#2C5BA9"

# Paleta de cores
cores <- c(
  cbc  = azulClaro,
  fem  = azulClaro,
  sim  = azulClaro,
  cec  = azulEscuro,
  masc = azulEscuro,
  nao  = azulEscuro
)

# Preparar dados anal√≠ticos (usado em v√°rias se√ß√µes)
lesoes_analise <- lesoes |>
  mutate(
    # Desfechos bin√°rios
    teve_complicacao = !is.na(complicacao) & str_squish(as.character(complicacao)) != "",
    teve_reintervencao = as.logical(reintervencao) %in% TRUE,
    margem_comprometida = case_when(
      is.na(margens_ap) ~ NA,
      str_detect(margens_ap, "comprometid") ~ TRUE,
      margens_ap == "livres" ~ FALSE,
      TRUE ~ NA
    ),
    
    # Fechamento categorizado
    fech_label = case_when(
      fech == "direto" ~ "Fechamento direto",
      fech == "retalho" ~ "Retalho",
      fech == "enxerto" ~ "Enxerto",
      fech == "2intencao" ~ "Segunda inten√ß√£o",
      TRUE ~ as.character(fech)
    ),
    
    # Localiza√ß√£o agrupada
    local_grupo = case_when(
      localizacao == "face" ~ "Face",
      localizacao == "orelha" ~ "Orelha",
      localizacao == "couro cabeludo" ~ "Couro cabeludo",
      localizacao %in% c("t√≥rax", "dorso") ~ "Tronco",
      localizacao == "cervical" ~ "Cervical",
      str_detect(localizacao, "membro superior|antebra√ßo") ~ "Membro superior",
      str_detect(localizacao, "membro inferior|p√©") ~ "Membro inferior",
      TRUE ~ "Outro"
    ),
    
    # Subtipo agressivo (CBC)
    subtipo_agressivo = case_when(
      histo_tipo != "cbc" ~ NA,
      str_detect(histo_subtipo, "infiltrativo|escleroderm|micronodular") ~ TRUE,
      TRUE ~ FALSE
    ),
    
    # Tipo histol√≥gico padronizado
    tipo_label = toupper(histo_tipo)
  )

# Juntar dados do paciente √†s les√µes
comorb_cols <- c("has", "dm", "dlp", "ic", "fa", "drc", "alzheimer", "parkinson", "dpoc")
comorb_cols <- intersect(comorb_cols, names(pacientes))

pacientes_compl <- pacientes |>
  mutate(
    n_comorb = rowSums(across(all_of(comorb_cols), ~ as.integer(.x %in% TRUE)), na.rm = TRUE),
    faixa_comorb = cut(n_comorb, breaks = c(-1, 0, 2, Inf), labels = c("0", "1-2", "3+"))
  )

lesoes_full <- lesoes_analise |>
  left_join(
    pacientes_compl |> select(paciente, idade, sexo, fototipo, n_comorb, faixa_comorb),
    by = "paciente"
  )
```

```{r}
# Fun√ß√£o auxiliar para tradu√ß√£o de partes em ingl√™s das tabelas

ptbr <- function(x,
                 local = c("geral", "header", "footnote", "source_note", "title", "subtitle"
                 ),
                 dict_extra = NULL,
                 warn_untranslated = FALSE) {
  local <- match.arg(local)
  if (!is.character(x)) x <- as.character(x)

  # Dicion√°rio "por contexto" (voc√™ pode ir crescendo isso aos poucos)
  dict <- list(
    geral = c(
      "p-value" = "p-valor",
      "95% CI" = "IC 95%",
      "Characteristic" = "Caracter√≠stica",
      "Overall" = "Total",
      "Abbreviations" = "Abrevia√ß√µes",
      "Fisher's exact test" = "Teste exato de Fisher",

      # frases inteiras comuns (mais seguro do que trocar "CI" solto)
      "CI = Confidence Interval, OR = Odds Ratio" = "IC = Intervalo de confian√ßa, OR = Raz√£o de chances"
    ),
    header = c(
      "p-value" = "p-valor",
      "95% CI" = "IC 95%",
      "Characteristic" = "Caracter√≠stica",
      "Overall" = "Total",
      "Abbreviations" = "Abrevia√ß√µes"
    ),
    footnote = c(
      "Fisher's exact test" = "Teste exato de Fisher",
      "CI = Confidence Interval, OR = Odds Ratio" = "IC = Intervalo de confian√ßa, OR = Raz√£o de chances"
    ),
    source_note = c(
      "Abbreviations" = "Abrevia√ß√µes",
      "CI = Confidence Interval, OR = Odds Ratio" = "IC = Intervalo de confian√ßa, OR = Raz√£o de chances"
    ),
    title = c(),
    subtitle = c()
  )

  # Junta: geral + local + extras do usu√°rio
  map <- c(dict$geral, dict[[local]])
  if (!is.null(dict_extra)) map <- c(map, dict_extra)

  # Fun√ß√£o de tradu√ß√£o para um elemento
  translate_one <- function(s) {
    # 1) se casar exato com alguma chave, troca direto
    if (s %in% names(map)) return(unname(map[s]))

    # 2) sen√£o, aplica substitui√ß√µes "fixas" (sem regex) em cascata
    # ordena por tamanho pra n√£o trocar peda√ßos antes da hora
    keys <- names(map)[order(nchar(names(map)), decreasing = TRUE)]
    out <- s
    for (k in keys) {
      out <- gsub(k, map[[k]], out, fixed = TRUE)
    }
    out
  }

  out <- vapply(x, translate_one, FUN.VALUE = character(1))

  if (warn_untranslated) {
    unchanged <- x == out
    if (any(unchanged)) {
      warning("ptbr(): sem tradu√ß√£o para: ", paste(unique(x[unchanged]), collapse = ", "))
    }
  }

  out
}
```

# Disclaimer

Hello didi, esse documento √© uma vers√£o turbinada da an√°lise dos teus dados. Organizei tudo de um jeito que d√° pra ver o que est√° acontecendo, entender os padr√µes, e ‚Äî o mais importante ‚Äî **testar se as diferen√ßas que a gente enxerga s√£o reais ou s√≥ obra do acaso**.

**O que temos em m√£os:**

-   **`r nrow(pacientes)` pacientes** no total
-   **`r nrow(lesoes)` les√µes** operadas no total

**O plano de voo:**

1.  **Descritiva** ‚Äî Quem s√£o os pacientes? Como s√£o as les√µes?
2.  **Bivariada** ‚Äî O que se associa com complica√ß√£o? Com margem comprometida?
3.  **Multivariada** ‚Äî Quando ajustamos por outras vari√°veis, o efeito persiste?
4.  **Quem voltou?** ‚Äî Os 17 pacientes com 2 visitas s√£o diferentes?

Bora?

------------------------------------------------------------------------

# Parte I: Descritiva {#sec-descritiva}

## Quem s√£o esses velhos?

### O b√°sico: idade, sexo, fototipo

```{r}
#| label: tbl-demografica
#| tbl-cap: "Caracter√≠sticas dos pacientes"

df_tab <- pacientes |>
  mutate(
    sexo_label = factor(sexo, c("f", "m"), c("Feminino", "Masculino")),
    fototipo = factor(fototipo)
  )

tbl_idade_gts <- df_tab |>
  select(idade) |>
  tbl_summary(
    label = list(idade ~ "Idade (anos)"),
    statistic = list(all_continuous() ~ "{median} ({p25}‚Äì{p75})"),
    digits = list(all_continuous() ~ 1),
    missing = "no"
  )

tbl_outros_gts <- df_tab |>
  select(sexo_label, fototipo, cbc_cec_previo, mohs, mais_cx, obito) |>
  tbl_summary(
    label = list(
      sexo_label ~ "Sexo",
      fototipo ~ "Fototipo (Fitzpatrick)",
      cbc_cec_previo ~ "J√° teve CBC/CEC antes",
      mohs ~ "Fez Mohs",
      mais_cx ~ "Teve outras cirurgias",
      obito ~ "Faleceu no seguimento"
    ),
    statistic = list(all_categorical() ~ "{n} ({p}%)"),
    digits = list(all_categorical() ~ c(0, 1)),
    missing = "no"
  )

tbl_idade_gt <- tbl_idade_gts |> bold_labels() |> as_gt()
tbl_outros_gt <- tbl_outros_gts |> bold_labels() |> as_gt()

if (knitr::is_html_output()) {
  htmltools::div(
    style = "display:flex; gap:18px; align-items:flex-start;",
    htmltools::div(style = "flex: 0 0 32%;", htmltools::HTML(gt::as_raw_html(tbl_idade_gt))),
    htmltools::div(style = "flex: 1 1 68%;", htmltools::HTML(gt::as_raw_html(tbl_outros_gt)))
  )
} else {
  tbl_idade_gts |> bold_labels() |> as_flex_table()
  tbl_outros_gts |> bold_labels() |> as_flex_table()
}
```

```{r}
#| label: fig-idade
#| fig-cap: "Distribui√ß√£o de idade"

pacientes |>
  ggplot(aes(x = idade)) +
  geom_histogram(binwidth = 1, fill = cores["cbc"], color = "white", alpha = 0.8) +
  geom_vline(xintercept = median(pacientes$idade), linetype = "dashed", color = "gray30", linewidth = 0.8) +
  annotate("text", x = median(pacientes$idade) + 0.5, y = Inf, vjust = 2, hjust = 0,
           label = paste0("Mediana: ", median(pacientes$idade), " anos"), size = 3.5, color = "gray30") +
  scale_x_continuous(breaks = seq(90, 110, 2)) +
  labs(x = "Idade (anos)", y = "N√∫mero de pacientes",
       title = "A idade dos teus pacientes", subtitle = "Todo mundo tem 90+, mas olha a varia√ß√£o!")
```

Mediana de `r median(pacientes$idade)` anos. Metade dos pacientes tem **mais** que isso. √â gente bem idosa mesmo.

### E as comorbidades?

```{r}
#| label: fig-comorbidades
#| fig-cap: "As comorbidades mais comuns"

comorb_labels <- c(
  has = "Hipertens√£o", dm = "Diabetes", dlp = "Dislipidemia",
  ic = "Insuf. card√≠aca", fa = "Fibrila√ß√£o atrial", drc = "Doen√ßa renal cr√¥nica",
  alzheimer = "Alzheimer", parkinson = "Parkinson", dpoc = "DPOC"
)

comorb_prev <- pacientes |>
  summarise(across(all_of(comorb_cols), ~ sum(.x, na.rm = TRUE))) |>
  pivot_longer(everything(), names_to = "comorbidade", values_to = "n") |>
  mutate(pct = n / nrow(pacientes) * 100, label = comorb_labels[comorbidade], label = fct_reorder(label, pct))

comorb_prev |>
  ggplot(aes(x = label, y = pct)) +
  geom_col(fill = cores["cbc"], width = 0.7) +
  geom_text(aes(label = sprintf("%.0f%%", pct)), hjust = -0.2, size = 3.5) +
  coord_flip() +
  scale_y_continuous(limits = c(0, 100), labels = \(x) paste0(x, "%")) +
  labs(x = NULL, y = "Preval√™ncia", title = "O que eles t√™m al√©m do c√¢ncer de pele",
       subtitle = "Spoiler: hipertens√£o lidera disparado")
```

**Hipertens√£o** em `r round(comorb_prev$pct[comorb_prev$comorbidade == "has"])`% das vovozinhas. Nenhuma surpresa, n√©?

------------------------------------------------------------------------

## As les√µes

### CBC ou CEC?

```{r}
#| label: fig-tipo-histo
#| fig-cap: "Distribui√ß√£o por tipo histol√≥gico"

lesoes |>
  filter(!is.na(histo_tipo)) |>
  count(histo_tipo) |>
  mutate(pct = n / sum(n), label_pct = scales::percent(pct, accuracy = 0.1),
         label = toupper(histo_tipo), label = fct_reorder(label, n, .desc = TRUE)) |>
  ggplot(aes(x = label, y = n, fill = histo_tipo)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = label_pct), position = position_stack(vjust = 0.5), color = "white", fontface = "bold", size = 4) +
  geom_text(aes(label = n), vjust = -0.4, color = "gray20", fontface = "bold", size = 4) +
  scale_fill_manual(values = cores[c("cbc", "cec")], guide = "none") +
  scale_y_continuous(expand = expansion(mult = c(0, 0.12))) +
  labs(x = NULL, y = "N√∫mero de les√µes", title = "CBC domina, chocando um total de zero pessoas",
       subtitle = paste0("Total: ", nrow(lesoes), " les√µes"))
```

```{r}
#| label: calc-tipos
pct_cbc <- mean(lesoes$histo_tipo == "cbc", na.rm = TRUE) * 100
pct_cec <- mean(lesoes$histo_tipo == "cec", na.rm = TRUE) * 100
```

CBC representa `r sprintf("%.0f", pct_cbc)`% das les√µes. Mas os `r sprintf("%.0f", pct_cec)`% de CEC s√£o mais preocupantes em termos de agressividade.

### Desfechos: o resumo r√°pido

```{r}
#| label: tbl-desfechos-resumo

n_compl <- sum(lesoes_analise$teve_complicacao, na.rm = TRUE)
n_marg <- sum(lesoes_analise$margem_comprometida, na.rm = TRUE)
n_reint <- sum(lesoes_analise$teve_reintervencao, na.rm = TRUE)

tibble(
  Desfecho = c("Complica√ß√£o", "Margem comprometida", "Reinterven√ß√£o"),
  n = c(n_compl, n_marg, n_reint),
  `%` = sprintf("%.1f%%", 100 * c(n_compl, n_marg, n_reint) / nrow(lesoes))
) |>
  gt() |>
  tab_header(title = "Resumo dos desfechos", subtitle = paste0("N = ", nrow(lesoes), " les√µes"))
```

Poucos eventos, mas o suficiente pra gente investigar!

------------------------------------------------------------------------

# Parte II: An√°lise Bivariada {#sec-bivariada}

Agora a gente sai da contagem e entra na **associa√ß√£o**. A pergunta √©: *"quem complica mais?"*

::: callout-note
## Por que vamos usar o Teste Exato de Fisher (e n√£o Qui-quadrado)?

Com poucos eventos (13 complica√ß√µes, 7 margens comprometidas), o teste de Fisher √© mais confi√°vel. Ele calcula a probabilidade exata, sem depender de aproxima√ß√µes que funcionam mal com N pequeno.
:::

## Fatores associados a COMPLICA√á√ÉO

```{r}
#| label: tbl-bivariada-complicacao
#| tbl-cap: "An√°lise bivariada: fatores associados a complica√ß√£o"

lesoes_biv <- lesoes_full |>
  filter(!is.na(teve_complicacao)) |>
  mutate(
    # R√≥tulo robusto (funciona se veio logical, 0/1, "TRUE"/"FALSE", etc.)
    teve_complicacao_label = case_when(
      tolower(as.character(teve_complicacao)) %in% c("true", "t", "1", "sim") ~ "Sim",
      TRUE ~ "N√£o"
    ) |> factor(levels = c("N√£o", "Sim")),

    sexo_label = factor(sexo, c("f", "m"), c("Feminino", "Masculino")),
    tipo_label = factor(tipo_label, c("CBC", "CEC")),
    fech_simples = case_when(
      fech_label == "Fechamento direto" ~ "Direto/2¬™ inten√ß√£o",
      fech_label == "Segunda inten√ß√£o" ~ "Direto/2¬™ inten√ß√£o",
      TRUE ~ "Retalho/Enxerto"
    ) |> factor(levels = c("Direto/2¬™ inten√ß√£o", "Retalho/Enxerto")),
    idade_cat = cut(idade, breaks = c(89, 92, 95, Inf), labels = c("90-92", "93-95", "96+"))
  )

tbl_biv_compl <- lesoes_biv |>
  select(
    teve_complicacao_label,
    sexo_label, idade_cat, faixa_comorb, tipo_label, fech_simples, local_grupo
  ) |>
  tbl_summary(
    by = teve_complicacao_label,
    label = list(
      sexo_label ~ "Sexo",
      idade_cat ~ "Faixa et√°ria",
      faixa_comorb ~ "N¬∫ comorbidades",
      tipo_label ~ "Tipo histol√≥gico",
      fech_simples ~ "T√©cnica de fechamento",
      local_grupo ~ "Localiza√ß√£o"
    ),
    statistic = all_categorical() ~ "{n} ({p}%)",
    digits = all_categorical() ~ c(0, 1),
    missing = "no"
  ) |>
  add_p(test = all_categorical() ~ "fisher.test") |>
  add_overall() |>
  modify_header(
    label ~ "**Caracter√≠stica**",
    stat_0 ~ "**Total**",
    stat_1 ~ "**N√£o**",
    stat_2 ~ "**Sim**",
    p.value ~ "**p-valor**"
  ) |>
  modify_footnote(
    p.value ~ "Teste exato de Fisher"
  ) |>
  bold_p(t = 0.05) |>
  bold_labels()

tbl_biv_compl |>
  as_gt() |>
  tab_header(
    title = "Quem complica mais?",
    subtitle = "An√°lise bivariada com teste exato de Fisher"
  )
```

```{r}
#| label: calc-or-fech

# OR bruto: fechamento complexo vs simples
tab_fech <- table(lesoes_biv$fech_simples, lesoes_biv$teve_complicacao)
or_fech <- fisher.test(tab_fech)
```

::: callout-important
## Repara:

**T√©cnica de fechamento** parece fazer diferen√ßa. Retalho e enxerto t√™m mais complica√ß√£o que fechamento direto/2¬™ inten√ß√£o.

-   OR bruto: **`r sprintf("%.1f", or_fech$estimate)`** (IC95%: `r sprintf("%.1f‚Äì%.1f", or_fech$conf.int[1], or_fech$conf.int[2])`)
-   p = **`r sprintf("%.3f", or_fech$p.value)`** (!!!)

Mas calma ‚Äî isso pode ser confus√£o. Les√µes que precisam de retalho/enxerto provavelmente s√£o maiores, em locais mais dif√≠ceis... A gente precisa ajustar.
:::

## Fatores associados a MARGEM COMPROMETIDA

```{r}
#| label: tbl-bivariada-margem
#| tbl-cap: "An√°lise bivariada: fatores associados a margem comprometida"

lesoes_biv_marg <- lesoes_full |>
  filter(!is.na(margem_comprometida)) |>
  mutate(
    margem_comprometida_label = case_when(
      tolower(as.character(margem_comprometida)) %in% c("true", "t", "1", "sim") ~ "Sim",
      TRUE ~ "N√£o"
    ) |> factor(levels = c("N√£o", "Sim")),

    tipo_label = factor(tipo_label, c("CBC", "CEC")),
    fech_simples = case_when(
      fech_label == "Fechamento direto" ~ "Direto/2¬™ inten√ß√£o",
      fech_label == "Segunda inten√ß√£o" ~ "Direto/2¬™ inten√ß√£o",
      TRUE ~ "Retalho/Enxerto"
    ) |> factor(levels = c("Direto/2¬™ inten√ß√£o", "Retalho/Enxerto"))
  )

# Subtipos agressivos de CBC
lesoes_cbc_marg <- lesoes_biv_marg |>
  filter(histo_tipo == "cbc", !is.na(subtipo_agressivo))

tbl_biv_marg <- lesoes_biv_marg |>
  select(margem_comprometida_label, tipo_label, fech_simples, local_grupo) |>
  tbl_summary(
    by = margem_comprometida_label,
    label = list(
      tipo_label ~ "Tipo histol√≥gico",
      fech_simples ~ "T√©cnica de fechamento",
      local_grupo ~ "Localiza√ß√£o"
    ),
    statistic = all_categorical() ~ "{n} ({p}%)",
    digits = all_categorical() ~ c(0, 1),
    missing = "no"
  ) |>
  add_p(test = all_categorical() ~ "fisher.test") |>
  add_overall() |>
  modify_header(
    label ~ "**Caracter√≠stica**",
    stat_0 ~ "**Total**",
    stat_1 ~ "**N√£o**",
    stat_2 ~ "**Sim**",
    p.value ~ "**p-valor**"
  ) |>
  modify_footnote(
    p.value ~ "Teste exato de Fisher"
  ) |>
  bold_p(t = 0.05) |>
  bold_labels()

tbl_biv_marg |>
  as_gt() |>
  tab_header(
    title = "Quem tem mais margem comprometida?",
    subtitle = "An√°lise bivariada com teste exato de Fisher"
  )
```

```{r}
#| label: tbl-subtipo-agressivo
#| tbl-cap: "CBC: subtipos agressivos vs indolentes"

if (nrow(lesoes_cbc_marg) > 0 && sum(!is.na(lesoes_cbc_marg$subtipo_agressivo)) > 5) {

  tbl_sub <- lesoes_cbc_marg |>
    mutate(
      margem_label = case_when(
        tolower(as.character(margem_comprometida)) %in% c("true", "t", "1", "sim") ~ "Margem comprometida",
        TRUE ~ "Margem livre"
      ) |> factor(levels = c("Margem livre", "Margem comprometida")),

      subtipo_cat = case_when(
        subtipo_agressivo ~ "Agressivo (infiltrativo, esclerod., micronod.)",
        TRUE ~ "Indolente (nodular, superficial, outros)"
      ) |> factor(levels = c(
        "Indolente (nodular, superficial, outros)",
        "Agressivo (infiltrativo, esclerod., micronod.)"
      ))
    ) |>
    select(margem_label, subtipo_cat) |>
    tbl_summary(
      by = margem_label,
      label = list(subtipo_cat ~ "Subtipo de CBC"),
      statistic = all_categorical() ~ "{n} ({p}%)",
      missing = "no"
    ) |>
    add_p(test = all_categorical() ~ "fisher.test")

  # PATCH (fora do pipe principal)
  tbl_sub <- tbl_sub |>
    modify_header(
      label ~ "**Caracter√≠stica**",
      p.value ~ "**p-valor**"
    ) |>
    modify_footnote(p.value ~ "Teste exato de Fisher")

  if ("stat_0" %in% names(tbl_sub$table_body)) {
    tbl_sub <- tbl_sub |>
      modify_header(stat_0 ~ "**Total**")
  }

  tbl_sub <- tbl_sub |>
    bold_p(t = 0.05) |>
    bold_labels()

  tbl_sub |>
    as_gt() |>
    tab_header(
      title = "Subtipos agressivos t√™m mais margem comprometida?",
      subtitle = "S√≥ CBCs"
    )
}
```

Os n√∫meros s√£o pequenos, mas j√° d√° pra ter uma no√ß√£o. Guarda essas informa√ß√µes ‚Äî elas v√£o voltar na discuss√£o.

------------------------------------------------------------------------

# An√°lise Multivariada {#sec-multivariada}

## *(Porque sonhar n√£o custa nada)*

Aqui √© onde a magia acontece, tipo Beto Carreiro. A gente ajusta uma vari√°vel pela outra pra ver se o efeito **persiste** ou se era s√≥ confus√£o.

::: callout-warning
## Limita√ß√£o importante

Com apenas `r n_compl` complica√ß√µes, n√£o d√° pra colocar muitas vari√°veis no modelo. A regra que eu inventei √© de \~10 eventos por vari√°vel. Ent√£o vou ser conservador: **modelo com 1 vari√°vel, 2 no m√°ximo**.
:::

## Modelo: Complica√ß√£o \~ T√©cnica de fechamento + Tipo histol√≥gico

```{r}
#| label: modelo-complicacao

lesoes_modelo <- lesoes_biv |>
  filter(!is.na(fech_simples), !is.na(tipo_label))

if (n_compl >= 8) {
  mod_compl <- glm(
    teve_complicacao ~ fech_simples + tipo_label,
    data = lesoes_modelo,
    family = binomial(link = "logit")
  )

  tbl_mod <- mod_compl |>
    gtsummary::tbl_regression(
      exponentiate = TRUE,
      label = list(
        fech_simples ~ "T√©cnica de fechamento",
        tipo_label ~ "Tipo histol√≥gico"
      )
    ) |>
    # IC em 1 coluna: junta conf.low + conf.high e esconde conf.high
    gtsummary::modify_column_merge(
      pattern = "{conf.low}, {conf.high}",
      rows = !is.na(.data$estimate)
    ) |>
    gtsummary::modify_column_hide(columns = "conf.high") |>
    # Cabe√ßalhos em PT-BR + IC com nota
    gtsummary::modify_header(
      label ~ "**Caracter√≠stica**",
      p.value ~ "**p-valor**",
      conf.low ~ "**IC 95%**"
    ) |>
    # Rodap√© explicando o ‚Äú¬π‚Äù
    gtsummary::modify_footnote(
      conf.low ~ "IC 95% (inferior, superior)"
    ) |>
    # Remove a nota autom√°tica ‚ÄúAbbreviations: ‚Ä¶‚Äù (em ingl√™s)‚Ä¶
    gtsummary::remove_abbreviation() |>
    # ‚Ä¶e coloca uma em PT-BR do teu jeito
    gtsummary::modify_source_note(
      "Abrevia√ß√µes: IC = Intervalo de confian√ßa; OR = Raz√£o de chances"
    ) |>
    gtsummary::bold_p(t = 0.05) |>
    gtsummary::bold_labels()

  tbl_mod |>
    as_gt() |>
    gt::tab_header(
      title = "Modelo multivariado: fatores associados a complica√ß√£o",
      subtitle = "Regress√£o log√≠stica ‚Äî OR ajustado (IC 95%)"
    )
} else {
  cat("N de eventos muito pequeno para modelo multivariado confi√°vel.")
}
```

```{r}
#| label: interpretacao-modelo
#| results: asis

if (exists("mod_compl")) {
  coefs <- tidy(mod_compl, exponentiate = TRUE, conf.int = TRUE)
  or_fech_aj <- coefs |> filter(str_detect(term, "fech_simples"))
  
  if (nrow(or_fech_aj) > 0) {
    cat(sprintf(
      "\n**Interpreta√ß√£o:** Ap√≥s ajustar por tipo histol√≥gico, a t√©cnica de fechamento (retalho/enxerto vs direto) tem OR ajustado de **%.1f** (IC95%%: %.1f‚Äì%.1f).\n\n",
      or_fech_aj$estimate[1],
      or_fech_aj$conf.low[1],
      or_fech_aj$conf.high[1]
    ))
  }
}
```

::: callout-tip
## Agora em portugu√™s brasileiro:

Se o OR ajustado continua elevado e significativo, a t√©cnica de fechamento √© um preditor **independente** de complica√ß√£o ‚Äî n√£o √© s√≥ porque as les√µes eram mais complexas.

Se o OR cai ou perde signific√¢ncia, significa que a associa√ß√£o bruta era confundida por outras vari√°veis.

Nossos achados indicam que enxertos e retalhos aumentam quase 5x a chance de complica√ß√£o na nossa popula√ß√£o de gente velha.
:::

------------------------------------------------------------------------

# O URSO VOLTOU!!, ELE VOLTOU!!! {#sec-recorrencia}

Dos `r nrow(pacientes)` pacientes, **`r sum(lesoes |> group_by(paciente) |> summarise(v = n_distinct(visita)) |> pull(v) == 2)`** tiveram uma segunda cirurgia (visita 2). Isso levanta algumas perguntas:

-   Quem s√£o esses pacientes que voltam?
-   A segunda cirurgia complica mais?

```{r}
#| label: tbl-visitas
#| tbl-cap: "Compara√ß√£o entre visita 1 e visita 2"

lesoes_visita <- lesoes_full |>
  mutate(visita_label = factor(visita, c(1, 2), c("Primeira cirurgia", "Segunda cirurgia")))

tbl_visita <- lesoes_visita |>
  select(visita_label, teve_complicacao, margem_comprometida, tipo_label) |>
  tbl_summary(
    by = visita_label,
    label = list(
      teve_complicacao ~ "Complica√ß√£o",
      margem_comprometida ~ "Margem comprometida",
      tipo_label ~ "Tipo histol√≥gico"
    ),
    statistic = all_categorical() ~ "{n} ({p}%)",
    missing = "no"
  ) |>
  add_p(test = all_categorical() ~ "fisher.test")

# >>> INSERIDO AQUI: patch ptbr (cabe√ßalho + rodap√© Fisher)
tbl_visita <- tbl_visita |>
  gtsummary::modify_header(
    label  ~ paste0("**", ptbr("Characteristic", "header"), "**"),
    p.value ~ paste0("**", ptbr("p-value", "header"), "**")
  ) |>
  gtsummary::modify_footnote(
    p.value ~ ptbr("Fisher's exact test", "footnote")
  )
# <<< FIM DO PATCH

tbl_visita <- tbl_visita |>
  bold_p(t = 0.05) |>
  bold_labels()

tbl_visita |>
  as_gt() |>
  gt::tab_header(
    title = "Primeira vs segunda visitas",
    subtitle = "Os que voltam s√£o diferentes?"
  )
```

```{r}
#| label: fig-visita-complic
#| fig-cap: "Taxa de complica√ß√£o por visita"

lesoes_visita |>
  group_by(visita_label) |>
  summarise(
    n = n(),
    compl = sum(teve_complicacao, na.rm = TRUE),
    taxa = 100 * compl / n,
    .groups = "drop"
  ) |>
  ggplot(aes(x = visita_label, y = taxa, fill = visita_label)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = sprintf("%.1f%%\n(n=%d)", taxa, compl)), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#2E86AB", "#A23B72"), guide = "none") +
  scale_y_continuous(limits = c(0, 30), labels = \(x) paste0(x, "%")) +
  labs(
    x = NULL, y = "Taxa de complica√ß√£o",
    title = "A segunda cirurgia complica mais?",
    subtitle = "Compara√ß√£o entre primeira e segunda visita"
  )
```

Essa an√°lise √© explorat√≥ria ‚Äî o N √© pequeno e os pacientes que voltam podem ser diferentes desde o in√≠cio (vi√©s de sele√ß√£o).

------------------------------------------------------------------------

# Heatmaps üî•ü•µ {#sec-heatmaps}

Heatmaps s√£o √≥timos pra visualizar padr√µes que tabelas podem esconder. Fiz alguns pra gente explorar juntooo.

## T√©cnica de fechamento √ó Desfechos

```{r}
#| label: fig-heatmap-fech-desfechos
#| fig-cap: "Heatmap de desfechos por t√©cnica de fechamento"
#| fig-width: 10
#| fig-height: 5

fech_levels <- c("Fechamento direto", "Enxerto", "Retalho", "Segunda inten√ß√£o")

fd <- lesoes_analise |>
  mutate(fech_label = factor(fech_label, levels = fech_levels)) |>
  filter(!is.na(fech_label)) |>
  select(fech_label, teve_complicacao, margem_comprometida, teve_reintervencao)

long <- fd |>
  pivot_longer(
    cols = c(teve_complicacao, margem_comprometida, teve_reintervencao),
    names_to = "desfecho", values_to = "valor"
  ) |>
  mutate(
    desfecho = factor(desfecho,
      levels = c("teve_complicacao", "margem_comprometida", "teve_reintervencao"),
      labels = c("Complica√ß√£o", "Margem comprometida", "Reinterven√ß√£o")
    )
  )

heat_fd <- long |>
  group_by(fech_label, desfecho) |>
  summarise(
    n_sim = sum(valor %in% TRUE, na.rm = TRUE),
    n_denom = sum(!is.na(valor)),
    pct = if_else(n_denom > 0, 100 * n_sim / n_denom, NA_real_),
    label = if_else(n_denom > 0, sprintf("%d\n(%.0f%%)", n_sim, pct), ""),
    .groups = "drop"
  )

heat_fd |>
    ggplot(aes(x = desfecho, y = fech_label, fill = pct)) +
    geom_tile(color = "white", linewidth = 0.6) +
    geom_text(aes(label = label), size = 3.4) +
    scale_x_discrete(position = "top") +
    scale_fill_gradient(
        low = "#f7f7f7",
        high = "#E63946",
        limits = c(0, 60),
        breaks = c(0, 20, 40, 60),
        labels = \(x) paste0(x, "%"),
        na.value = "white") +
    guides(
        fill = guide_colorbar(
            title.position = "top",
            title.hjust = 0.5
        )
    ) +
    labs(x = NULL, y = NULL, fill = "% de les√µes com evento (na t√©cnica)",
       title = "Desfechos por t√©cnica de fechamento",
       subtitle = "Quanto mais vermelho, mais eventos (escala de 0 a 60% para melhorar visibilidade)") +
    theme(
        axis.text.x = element_text(face = "bold"),
        axis.text.y = element_text(size = 10),
        plot.subtitle = element_text(margin = margin(b = 24))
        )
```

Olha como **retalho e enxerto** ficam mais "quentes" na coluna de complica√ß√£o. N√£o √© coincid√™ncia.

## Subtipo de CBC √ó Margens

```{r}
#| label: fig-barra-subtipo-margens
#| fig-cap: "CBC: margens por subtipo"
#| fig-width: 10
#| fig-height: 5


```

```{r}
#| label: fig-divergente-cbc-margens
#| fig-cap: "Margens por subtipo de CBC (barras divergentes)"
#| fig-width: 9
#| fig-height: 5

# Preparar dados (filtro refor√ßado contra NA)
cbc_margens <- lesoes |>
  filter(tolower(histo_tipo) == "cbc") |>
  mutate(
    margem_status = case_when(
      is.na(margens_ap) ~ NA_character_,
      str_detect(margens_ap, "comprometida") ~ "Comprometidas",
      margens_ap == "livres" ~ "Livres",
      TRUE ~ NA_character_
    ),
    histo_subtipo = str_squish(as.character(histo_subtipo))
  ) |>
  filter(
    !is.na(margem_status),
    !is.na(histo_subtipo),
    histo_subtipo != "",
    histo_subtipo != "NA",
    !str_detect(histo_subtipo, "^[Nn][Aa]$")
  ) |>
  separate_rows(histo_subtipo, sep = ",\\s*") |>
  mutate(histo_subtipo = str_to_sentence(str_squish(histo_subtipo)))

# Calcular contagens
contagens <- cbc_margens |>
  count(histo_subtipo, margem_status) |>
  group_by(histo_subtipo) |>
  mutate(
    n_total = sum(n),
    pct = 100 * n / n_total
  ) |>
  ungroup() |>
  mutate(
    # Livres v√£o pra esquerda (negativo), comprometidas pra direita
    pct_plot = if_else(margem_status == "Livres", -pct, pct),
    label = sprintf("%d (%.0f%%)", n, pct)
  )

# Ordenar por taxa de comprometimento (mais arriscado em cima)
ordem <- contagens |>
  filter(margem_status == "Comprometidas") |>
  arrange(desc(pct)) |>
  pull(histo_subtipo)

# Adicionar subtipos sem comprometimento (taxa = 0)
subtipos_sem_compr <- setdiff(unique(contagens$histo_subtipo), ordem)
ordem <- c(ordem, subtipos_sem_compr)

contagens <- contagens |>
  mutate(histo_subtipo = factor(histo_subtipo, levels = rev(ordem)))

# Gr√°fico divergente
ggplot(contagens, aes(x = pct_plot, y = histo_subtipo, fill = margem_status)) +
  geom_col(width = 0.7) +
  geom_text(
    aes(label = label),
    hjust = if_else(contagens$margem_status == "Livres", 1.1, -0.1),
    size = 3, color = "gray20"
  ) +
  geom_vline(xintercept = 0, color = "gray40", linewidth = 0.8) +
  scale_x_continuous(
    labels = \(x) paste0(abs(x), "%"),
    limits = c(-110, 60)
  ) +
  scale_fill_manual(
    values = c("Livres" = "#2A9D8F", "Comprometidas" = "#E63946"),
    name = NULL
  ) +
  labs(
    x = "Propor√ß√£o (%)",
    y = NULL,
    title = "CBC: margens livres vs comprometidas por subtipo",
    subtitle = "‚Üê Livres | Comprometidas ‚Üí"
  ) +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "bottom"
  )
```

------------------------------------------------------------------------

# S√≠ntese {#sec-sintese}

```{r}
#| label: resumo-final

resumo <- tibble(
  Indicador = c(
    "Pacientes",
    "Les√µes",
    "Idade mediana",
    "Mulheres",
    "CBC",
    "Taxa de complica√ß√£o",
    "Margens comprometidas",
    "Pacientes com 2¬™ cirurgia"
  ),
  Valor = c(
    as.character(nrow(pacientes)),
    as.character(nrow(lesoes)),
    paste0(median(pacientes$idade), " anos"),
    sprintf("%.0f%%", 100 * mean(pacientes$sexo == "f")),
    sprintf("%.0f%%", pct_cbc),
    sprintf("%.1f%%", 100 * n_compl / nrow(lesoes)),
    sprintf("%.1f%%", 100 * n_marg / nrow(lesoes)),
    as.character(sum(lesoes |> group_by(paciente) |> summarise(v = n_distinct(visita)) |> pull(v) == 2))
  )
)

resumo |>
  gt() |>
  tab_header(title = "Resum√£o", subtitle = "Os n√∫meros principais")
```

## O que parece importar?

1.  **T√©cnica de fechamento:** Retalho e enxerto se associam a mais complica√ß√µes. Faz sentido clinicamente ‚Äî s√£o procedimentos mais complexos, em les√µes maiores.

2.  **Subtipos agressivos de CBC:** Os infiltrativos/esclerodermiformes parecem ter mais margem comprometida, mas o N √© pequeno pra cravar.

3.  **Segunda cirurgia:** Os pacientes que voltam merecem aten√ß√£o ‚Äî pode haver um perfil de risco diferente.

## Limita√ß√µes (pra colocar na discuss√£o)

-   **N pequeno:** Com 7 margens comprometidas e 13 complica√ß√µes, a gente tem poder estat√≠stico limitado.
-   **Dados correlacionados:** Pacientes com m√∫ltiplas les√µes violam independ√™ncia. Idealmente usar√≠amos GEE ou GLMM, mas o N n√£o permite.
-   **Vi√©s de sele√ß√£o:** Quem foi operado? Quem foi pra AP? Isso pode afetar os resultados.
-   **Retrospectivo:** A qualidade dos dados depende do que foi registrado na √©poca.

## Perguntas que ficam

-   Se tivesse mais casos, a associa√ß√£o subtipo agressivo ‚Üí margem comprometida seria significativa?
-   Os pacientes que voltam t√™m mais comorbidades? Les√µes mais agressivas?
-   Vale a pena estratificar por localiza√ß√£o (face vs resto)?

------------------------------------------------------------------------

# O Que Falta Fazer

-   [ ] Revisar os n√∫meros com o orientador
-   [ ] Decidir quais an√°lises entram no artigo final
-   [ ] Escrever a se√ß√£o de m√©todos (essa parte descritiva j√° d√° pra adiantar!)
-   [ ] Pensar no t√≠tulo do trabalho üòé

------------------------------------------------------------------------

**Uma coisa importante:** tudo que est√° aqui √© pra gente entender os dados. A narrativa final do artigo pode (e deve) ser mais... S√≥bria. Mas agora a gente tem uma vis√£o clara do que temos em m√µes

Me conta o que tu achou!

------------------------------------------------------------------------

*Gerado em `r format(Sys.time(), "%d/%m/%Y √†s %H:%M")`*
